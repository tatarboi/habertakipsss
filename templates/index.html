<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Samsun Haber Takip</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/tr.js"></script>
</head>
<body>
<div class="container py-4">
  <header class="d-flex flex-wrap align-items-center justify-content-between mb-4 pb-3 border-bottom">
    <h1 class="h3 m-0"><a href="/" class="text-dark text-decoration-none">ğŸ“° Samsun Haber Takip</a></h1>
    <form class="d-flex" role="search" style="width: 300px;">
      <input class="form-control" type="search" name="q" value="{{ q }}" placeholder="Yerel haberlerde araâ€¦">
      <button class="btn btn-primary ms-2">Ara</button>
    </form>
  </header>

  <h2 class="h4 mb-3">Yerel BasÄ±n</h2>
  <div id="local-grid" class="row g-3">
    {% for it in local_items %}
      <div class="col-12 col-md-6 col-lg-4">
        <article class="card h-100 shadow-sm">
          {% if it['image_url'] %}
            <a href="{{ it['url'] }}" target="_blank" rel="noopener"><img class="card-img-top" src="{{ it['image_url'] }}" loading="lazy" alt="haber gÃ¶rseli"></a>
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h3 class="card-title fs-6"><a href="{{ it['url'] }}" target="_blank" rel="noopener">{{ it['title'] }}</a></h3>
            <p class="card-text text-secondary small mb-2">{{ it['summary'] }}</p>
            <div class="mt-auto d-flex align-items-center justify-content-between">
              <span class="badge text-bg-light">{{ it['source'] }}</span>
              <time class="text-nowrap small text-muted" datetime="{{ (it['published'] or it['created_at']) }}">{{ (it['published'] or it['created_at']) }}</time>
            </div>
          </div>
        </article>
      </div>
    {% else %}
        <p class="text-center">Taranan yerel haber bulunamadÄ±.</p>
    {% endfor %}
  </div>

  <div class="text-center my-4">
    <button id="loadMore" class="btn btn-outline-secondary">Daha Fazla Yerel Haber YÃ¼kle</button>
  </div>

  <h2 class="h4 my-3 pt-3 border-top">Ulusal BasÄ±nda Samsun</h2>
  <div id="national-grid" class="row g-3">
      {% for it in national_items %}
        <div class="col-12 col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm">
            {% if it['image_url'] %}
              <a href="{{ it['url'] }}" target="_blank" rel="noopener"><img class="card-img-top" src="{{ it['image_url'] }}" loading="lazy" alt="haber gÃ¶rseli"></a>
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h3 class="card-title fs-6"><a href="{{ it['url'] }}" target="_blank" rel="noopener">{{ it['title'] }}</a></h3>
              <p class="card-text text-secondary small mb-2">{{ it['summary'] }}</p>
              <div class="mt-auto d-flex align-items-center justify-content-between">
                <span class="badge text-bg-dark">{{ it['source'] }}</span>
                <time class="text-nowrap small text-muted" datetime="{{ (it['published'] or it['created_at']) }}">{{ (it['published'] or it['created_at']) }}</time>
              </div>
            </div>
          </article>
        </div>
      {% else %}
        <p class="text-center">Taranan ulusal haberlerde "Samsun" iÃ§eriÄŸi bulunamadÄ±.</p>
      {% endfor %}
  </div>

</div>

<script>
  dayjs.extend(dayjs_plugin_relativeTime); dayjs.locale('tr');
  function humanizeTimes(){
    document.querySelectorAll('time[datetime]').forEach(t=>{
      if (t.textContent.includes('-')) { // Sadece formatlanmamÄ±ÅŸlarÄ± Ã§evir
        try { t.textContent = dayjs(t.getAttribute('datetime')).fromNow(); } catch(e){}
      }
    });
  }
  humanizeTimes();

  const btn = document.getElementById('loadMore');
  let lastItem = document.querySelector('#local-grid > div:last-child');

  btn?.addEventListener('click', async ()=>{
    if(!lastItem) return;
    const lastISO = lastItem.querySelector('time[datetime]').getAttribute('datetime');
    if(!lastISO) return;

    btn.disabled=true; btn.textContent='YÃ¼kleniyorâ€¦';
    const res = await fetch(`/api/articles?after=${encodeURIComponent(lastISO)}&limit=30`);
    const data = await res.json();
    const grid = document.getElementById('local-grid');

    data.items.forEach(it=>{
      const col = document.createElement('div'); col.className='col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <article class="card h-100 shadow-sm">
          ${it.image_url ? `<a href="${it.url}" target="_blank" rel="noopener"><img class="card-img-top" src="${it.image_url}" loading="lazy" alt="haber gÃ¶rseli"></a>`: ''}
          <div class="card-body d-flex flex-column">
            <h3 class="card-title fs-6"><a href="${it.url}" target="_blank" rel="noopener">${it.title}</a></h3>
            <p class="card-text text-secondary small mb-2">${(it.summary||'')}</p>
            <div class="mt-auto d-flex align-items-center justify-content-between">
              <span class="badge text-bg-light">${it.source}</span>
              <time class="text-nowrap small text-muted" datetime="${it.published || it.created_at}">${it.published || it.created_at}</time>
            </div>
          </div>
        </article>`;
      grid.appendChild(col);
    });

    lastItem = document.querySelector('#local-grid > div:last-child');
    humanizeTimes();
    btn.disabled=false; btn.textContent='Daha Fazla Yerel Haber YÃ¼kle';
    if(data.items.length === 0){
        btn.textContent = 'BaÅŸka haber yok';
        btn.disabled = true;
    }
  });

  // SayfayÄ± otomatik yenileme (isteÄŸe baÄŸlÄ±)
  // setInterval(()=>{ location.reload(); }, 60000); // 60 saniye
</script>
</body>
</html>